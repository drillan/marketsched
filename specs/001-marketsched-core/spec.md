# Feature Specification: marketsched コアライブラリ

**Feature Branch**: `001-marketsched-core`
**Created**: 2026-02-05
**Status**: Draft
**Input**: User description: "drafts/marketsched-spec.md をもとにコア仕様(実装をいれない)を策定してください"

## 概要

marketsched は、金融市場向けスケジュール管理ライブラリである。市場（Market）を抽象化し、営業日判定、取引時間管理、限月処理などの機能を提供する。初期実装ではJPXデリバティブ市場をサポートし、将来的に他の市場（東証株式、米国市場等）への拡張を可能にする設計とする。

### アーキテクチャ方針

```
┌─────────────────────────────────────────────────┐
│           marketsched コア                       │
│  - Market インターフェース（抽象化レイヤー）      │
│  - タイムゾーン変換                              │
│  - 共通の日付・時刻操作                          │
└─────────────────────────────────────────────────┘
                      ▲
                      │
    ┌─────────────────┼─────────────────┐
    │                 │                 │
┌───┴───┐      ┌──────┴──────┐    ┌─────┴─────┐
│JPXIndex│      │ JPX他カテゴリ │    │ (将来拡張) │
│(今回)  │      │ (将来拡張)   │    │東証/米国等 │
└────────┘      └─────────────┘    └───────────┘
                  - JPXEquityOptions
                  - JPXBond 等
```

### 対象市場（初期スコープ）

**市場ID: `jpx-index`**（JPX指数先物・オプション）

- 日経225先物
- 日経225mini
- 日経225マイクロ先物
- 日経225オプション

**将来の拡張候補**:
- `jpx-equity-options`（株式オプション）
- `jpx-bond`（債券・金利先物）
- `jpx-commodity`（商品先物）

### 基本原則

1. **市場の抽象化**: Market インターフェースにより、市場固有のルール（営業日、立会時間、SQ日等）を差し替え可能にする
2. **独立性**: 実行時の外部API依存なし（キャッシュ済みデータでスタンドアロン動作可能）
3. **一次情報の参照**: SQ日・休日判定は計算ではなく公式データを参照（公式サイトから自動取得してキャッシュ）
4. **タイムゾーン明示**: 全ての時刻は市場固有のタイムゾーンを基準とし、UTCで与えられた場合は換算して処理

### データソース（JPXデリバティブ用）

JPX公式データを一次情報として参照する：

- **取引最終日（SQ日）**: https://www.jpx.co.jp/derivatives/rules/last-trading-day/index.html
- **休業日データ（Excel）**: https://www.jpx.co.jp/derivatives/rules/holidaytrading/nlsgeu000006hweb-att/nlsgeu000006jgee.xlsx
- **祝日取引実施日**: https://www.jpx.co.jp/derivatives/rules/holidaytrading/index.html
- **立会時間**: https://www.jpx.co.jp/derivatives/rules/trading-hours/index.html

**営業日判定ルール**:
- 土日は休業日
- それ以外の休業日はJPX公式Excelデータに従う（年末年始・祝日のハードコード禁止）

---

## Clarifications

### Session 2026-02-05 (#1)

- Q: Story 5（15分遅延の補正）を削除するか？ → A: 削除（スコープ外として扱う）
- Q: FR-021のデータ管理方針は同梱か参照か？ → A: 参照（データは同梱せず利用者が用意）
- Q: UTCで時刻が与えられた場合の処理は？ → A: JSTに換算して処理する
- Q: 立会時間のデータソースを追加するか？ → A: 追加（JPX公式の立会時間ページを参照）
- Q: 将来の拡張（株式、米国市場等）に備えて抽象化するか？ → A: 市場(Market)の抽象化を導入する

### Session 2026-02-05 (#2) - データ管理方針の変更

- Q: データの提供方法は？ → A: **キャッシュのみ**（JPX公式サイトから自動取得してローカルキャッシュ、同梱データなし）
- 変更理由: CLI提供に伴い、利用者がデータを用意する手間を省き、即座に利用可能にするため
- 影響: FR-DM-001, FR-DM-002を更新、Out of Scopeから「公式データのダウンロード機能」を削除

### Session 2026-02-05 (#3) - セッション判定の現在時刻対応

- Q: システム時刻でセッション判定できるか？ → A: 時刻引数を省略した場合、現在のシステム時刻を使用する
- 影響: FR-TS-002, FR-TS-003を更新（時刻引数をオプショナルに）

### Session 2026-02-05 (#4) - 市場IDの粒度

- Q: 市場IDの粒度は？ → A: 商品カテゴリ単位でID分離（`jpx-index`, `jpx-equity-options`, `jpx-bond` 等）
- 理由: JPX内でも商品カテゴリにより取引時間が異なるため
- 初期スコープ: `jpx-index`（指数先物・オプション）のみ実装

### Session 2026-02-05 (#5) - 休業日判定の方針

- Q: 年末年始・祝日の判定方法は？ → A: JPX公式Excelデータのみに従う（ハードコード禁止）
- データソース: https://www.jpx.co.jp/derivatives/rules/holidaytrading/nlsgeu000006hweb-att/nlsgeu000006jgee.xlsx
- 土日は休業日（これのみハードコード可）
- 理由: 祝日取引実施日は年によって異なり、公式データが唯一の正確な情報源

---

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 限月の正規化と変換 (Priority: P1)

トレーダーやシステム開発者が、日本語表記の限月（例: 「26年3月限」）を標準形式に変換したい。また、逆に標準形式から日本語表記に戻したい。

**Why this priority**: 限月は先物・オプション取引の最も基本的な識別子であり、全ての機能の基盤となる。

**Independent Test**: 限月の入力と変換のみで完結し、他の機能に依存せずテスト可能。

**Acceptance Scenarios**:

1. **Given** 日本語表記「26年3月限」, **When** 正規化を実行, **Then** 年=2026、月=3として認識される
2. **Given** 日本語表記「2026年9月限」, **When** 正規化を実行, **Then** 年=2026、月=9として認識される
3. **Given** 正規化された限月（2026年3月）, **When** YYYYMM形式に変換, **Then** 「202603」が返される
4. **Given** 正規化された限月（2026年3月）, **When** 日本語形式に変換, **Then** 「2026年3月限」が返される
5. **Given** 無効な形式「3月限」（年なし）, **When** 正規化を実行, **Then** エラーが発生する

---

### User Story 2 - 営業日判定と取得 (Priority: P1)

トレーダーやシステムが、指定した市場において指定した日付が営業日かどうかを確認したい。また、前後の営業日を取得したい。

**Why this priority**: 注文のタイミング、決済日の計算、スケジュール管理に不可欠な基本機能。

**Independent Test**: 市場と日付を入力し営業日判定のみで完結し、他の機能に依存せずテスト可能。

**Acceptance Scenarios**:

1. **Given** JPXデリバティブ市場と平日（月〜金）かつ祝日でない日, **When** 営業日判定を実行, **Then** 営業日（true）が返される
2. **Given** JPXデリバティブ市場と土曜日または日曜日, **When** 営業日判定を実行, **Then** 休場日（false）が返される
3. **Given** JPXデリバティブ市場と祝日だが祝日取引実施日リストに含まれる日, **When** 営業日判定を実行, **Then** 営業日（true）が返される
4. **Given** JPXデリバティブ市場と12月31日または1月2日, **When** 営業日判定を実行, **Then** 休場日（false）が返される
5. **Given** JPXデリバティブ市場と金曜日, **When** 翌営業日を取得, **Then** 翌週月曜日が返される
6. **Given** JPXデリバティブ市場と月曜日, **When** 前営業日を取得, **Then** 前週金曜日が返される
7. **Given** JPXデリバティブ市場と期間（2月1日〜2月28日）, **When** 営業日リストを取得, **Then** 期間内の全営業日が昇順で返される

---

### User Story 3 - SQ日の参照と判定 (Priority: P1)

トレーダーやシステムが、指定した市場・年月のSQ日（特別清算指数算出日）を知りたい。また、特定の日付がSQ日かどうかを判定したい。

**Why this priority**: SQ日は先物・オプションのポジション管理に直接影響する重要な日付。

**Independent Test**: 市場と年月を指定してSQ日を取得するのみで完結し、テスト可能。

**Acceptance Scenarios**:

1. **Given** JPXデリバティブ市場と年月（2026年3月）, **When** 月次SQ日を取得, **Then** JPX公式データに基づくSQ日が返される
2. **Given** JPXデリバティブ市場とSQ日である日付, **When** SQ日判定を実行, **Then** true が返される
3. **Given** JPXデリバティブ市場とSQ日でない日付, **When** SQ日判定を実行, **Then** false が返される
4. **Given** JPXデリバティブ市場と年（2026年）, **When** 年間SQ日一覧を取得, **Then** 12ヶ月分のSQ日リストが昇順で返される
5. **Given** JPXデリバティブ市場とJPX公式データにない年月, **When** SQ日を取得, **Then** データ未存在エラーが発生する

---

### User Story 4 - 取引セッション判定 (Priority: P2)

トレーダーやシステムが、指定した市場・時刻（または現在時刻）がどの取引セッションに属するかを知りたい。また、取引可能時間かどうかを判定したい。

**Why this priority**: リアルタイムの取引判断やデータ取得のタイミング制御に必要だが、基本的な日付機能の後に必要となる。

**Independent Test**: 市場と時刻入力のみでセッション判定が完結し、テスト可能。

**Acceptance Scenarios**:

1. **Given** JPXデリバティブ市場と時刻 10:00 JST（平日）, **When** セッション取得を実行, **Then** 日中立会が返される
2. **Given** JPXデリバティブ市場と時刻 20:00 JST（平日）, **When** セッション取得を実行, **Then** ナイトセッションが返される
3. **Given** JPXデリバティブ市場と時刻 16:30 JST（ギャップ期間）, **When** 取引可能判定を実行, **Then** false が返される
4. **Given** JPXデリバティブ市場とセッション種別（日中立会）と日付, **When** セッション時間を取得, **Then** 開始時刻（08:45）と終了時刻（15:45）が返される
5. **Given** タイムゾーン情報のない時刻, **When** セッション判定を実行, **Then** エラーが発生する
6. **Given** JPXデリバティブ市場と時刻 01:00 UTC（= 10:00 JST）, **When** セッション取得を実行, **Then** JSTに換算され日中立会が返される
7. **Given** JPXデリバティブ市場と時刻引数なし, **When** セッション取得を実行, **Then** 現在のシステム時刻に基づくセッションが返される
8. **Given** JPXデリバティブ市場と時刻引数なし, **When** 取引可能判定を実行, **Then** 現在のシステム時刻で取引可能かどうかが返される

---

### User Story 5 - 市場の選択と設定 (Priority: P1)

システム開発者が、使用する市場を選択し、その市場固有のルールに基づいて各機能を利用したい。

**Why this priority**: 市場の抽象化はアーキテクチャの基盤であり、全ての機能が市場に依存する。

**Independent Test**: 市場の選択・取得のみで完結し、テスト可能。

**Acceptance Scenarios**:

1. **Given** JPXデリバティブ市場を選択, **When** 市場情報を取得, **Then** タイムゾーン=JST、市場名=JPXデリバティブが返される
2. **Given** 利用可能な市場一覧を要求, **When** 一覧取得を実行, **Then** JPXデリバティブが含まれるリストが返される
3. **Given** 存在しない市場を選択, **When** 市場取得を実行, **Then** 市場未定義エラーが発生する

---

### Edge Cases

- 限月として13月や0月が指定された場合、バリデーションエラーを返す
- 2桁年号（例: 99年）は2099年として解釈される（2000〜2099年の範囲）
- 閏年の2月29日の営業日判定が正しく動作する
- 年末年始の境界で正しく営業日判定が行われる（JPX公式Excelデータに基づく、ハードコード禁止）
- ナイトセッションの日付跨ぎ（17:00〜翌06:00）が正しく処理される
- JPX公式データに存在しない年月のSQ日取得時に適切なエラーを返す
- オフライン環境でキャッシュなしの場合、適切なエラーを返す
- 公式サイトのデータ形式が変更された場合、適切なエラーを返す
- UTC時刻が日付境界をまたぐ場合（例: UTC 15:00 = JST 翌日00:00）、正しくJSTの日付で判定される
- SQ日機能を持たない市場（将来の株式市場等）でSQ日を取得しようとした場合、機能未サポートエラーを返す

---

## Requirements *(mandatory)*

### Functional Requirements

#### 市場抽象化 (MKT)

- **FR-MKT-001**: システムは市場（Market）を抽象化したインターフェースを提供しなければならない
- **FR-MKT-002**: 各市場は固有のタイムゾーン、営業日ルール、取引セッション定義を持たなければならない
- **FR-MKT-003**: システムは利用可能な市場の一覧を取得できなければならない
- **FR-MKT-004**: システムは市場識別子により特定の市場を取得できなければならない
- **FR-MKT-005**: 市場がサポートしない機能（例: 株式市場のSQ日）を呼び出した場合、適切なエラーを返さなければならない

#### 限月正規化 (CM)

- **FR-CM-001**: システムは日本語表記の限月（「26年3月限」「2026年3月限」形式）を解析できなければならない
- **FR-CM-002**: システムは正規化された限月をYYYYMM形式、YYMM形式、日本語形式に変換できなければならない
- **FR-CM-003**: システムは2桁年号を2000〜2099年の範囲で解釈しなければならない
- **FR-CM-004**: システムは無効な限月形式に対してエラーを返さなければならない

#### 営業日判定 (BD)

- **FR-BD-001**: システムは指定された市場の公式データに基づいて営業日判定を行わなければならない
- **FR-BD-002**: システムは市場の休場日ルール（週末、祝日等）に従って判定しなければならない
- **FR-BD-003**: JPXデリバティブ市場では12月31日と1月2日を休場日として判定しなければならない
- **FR-BD-004**: システムは指定市場における指定日の前営業日・翌営業日を取得できなければならない
- **FR-BD-005**: システムは指定市場における指定期間内の営業日リストを取得できなければならない
- **FR-BD-006**: システムは指定市場における指定期間内の営業日数をカウントできなければならない

#### SQ日参照 (SQ)

- **FR-SQ-001**: システムは指定された市場の公式データに基づいてSQ日を参照しなければならない
- **FR-SQ-002**: システムは指定市場・年月の月次SQ日を取得できなければならない
- **FR-SQ-003**: システムは指定市場において指定日がSQ日かどうかを判定できなければならない
- **FR-SQ-004**: システムは指定市場の年間または月間のSQ日一覧を取得できなければならない
- **FR-SQ-005**: システムはデータが存在しない年月に対して適切なエラーを返さなければならない

#### 取引セッション管理 (TS)

- **FR-TS-001**: システムは指定された市場の取引セッション定義に基づいてセッションを識別しなければならない
- **FR-TS-002**: システムは指定市場において指定時刻（または現在時刻）が属するセッションを返せなければならない
- **FR-TS-003**: システムは指定市場において指定時刻（または現在時刻）が取引可能時間かどうかを判定できなければならない
- **FR-TS-004**: 時刻引数が省略された場合、現在のシステム時刻（市場のタイムゾーンで）を使用しなければならない
- **FR-TS-005**: JPXデリバティブ市場ではギャップ期間（15:46〜16:59, 06:01〜08:44）を取引時間外として判定しなければならない
- **FR-TS-006**: 明示的にタイムゾーン情報のない時刻が渡された場合は拒否しなければならない

#### タイムゾーン変換 (TZ)

- **FR-TZ-001**: システムはUTCで与えられた時刻を市場固有のタイムゾーンに換算して処理しなければならない
- **FR-TZ-002**: システムは任意のタイムゾーンで与えられた時刻を内部で市場固有のタイムゾーンに変換して判定しなければならない

#### データ管理 (DM)

- **FR-DM-001**: システムは市場の公式サイトからデータを自動取得し、ローカルにキャッシュしなければならない
- **FR-DM-002**: システムはキャッシュが存在しない場合、初回アクセス時に自動取得を試みなければならない
- **FR-DM-003**: システムはオフライン時かつキャッシュなしの場合、適切なエラーを返さなければならない
- **FR-DM-004**: システムはキャッシュの更新・クリア機能を提供しなければならない

---

### Key Entities

- **市場（Market）**: 取引が行われる場所を表す抽象化。タイムゾーン、営業日ルール、取引セッション定義、データソースを持つ。
- **限月（Contract Month）**: 先物・オプション契約の満期月を表す。年（4桁）と月（1-12）で構成される。
- **取引セッション（Trading Session）**: 市場における取引時間帯を表す。各セッションは開始時刻と終了時刻を持つ。
- **SQ日（SQ Date）**: 特別清算指数の算出日。商品種類と限月ごとに定められる。デリバティブ市場固有の概念。
- **祝日取引実施日（Holiday Trading Day）**: 祝日でも取引が行われる日。市場が公開するカレンダーに基づく。

---

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは全ての対応形式の限月を1秒以内に正規化・変換できる
- **SC-002**: ユーザーは任意の市場・日付の営業日判定を1秒以内に取得できる
- **SC-003**: ユーザーは市場の公式データと100%一致するSQ日を取得できる
- **SC-004**: ユーザーは市場の公式データと100%一致する営業日判定結果を取得できる
- **SC-005**: システムは市場の取引時間ルールに従ってセッションを正確に判定できる
- **SC-006**: 無効な入力に対して、ユーザーが問題を理解できるエラーメッセージを返す
- **SC-007**: キャッシュ未取得時（オフライン環境）に、ユーザーが対処方法を理解できるエラーメッセージを返す
- **SC-008**: UTC時刻で入力した場合も市場固有のタイムゾーンで入力した場合と同じ判定結果を得られる
- **SC-009**: 新しい市場を追加する際、既存コードの変更なしに市場定義の追加のみで対応できる

---

## Assumptions

- 各市場の公式サイトのデータ形式は年度間で大きく変更されない
- キャッシュデータはユーザーのローカルファイルシステムに保存される
- 時刻入力はタイムゾーン情報が必須（市場固有TZ、UTC、その他のタイムゾーン対応）
- タイムゾーン付き時刻は内部で市場固有のタイムゾーンに変換して処理される
- 初期実装ではJPXデリバティブ市場のみをサポートし、他の市場は将来追加する
- ナイトセッションの有無・時間帯は市場によって異なる
- 初回利用時またはキャッシュ更新時にはインターネット接続が必要

---

## Scope Boundaries

### In Scope

- Market インターフェースの定義と抽象化
- JPXデリバティブ市場の実装（初期スコープ）
- 限月の正規化と変換
- 市場の公式データに基づく営業日判定
- 市場の公式データに基づくSQ日参照
- 市場固有の取引セッション時間管理
- **公式サイトからのデータ自動取得機能**
- **ローカルキャッシュ機構**
- 任意のタイムゾーン→市場固有タイムゾーン変換

### Out of Scope

- JPXデリバティブ以外の市場実装（東証株式、米国市場等）
- 限月ロールオーバー判定
- 配当落ち日の計算
- 経済指標・決算発表等のイベントカレンダー
- リアルタイムデータの取得（データソースとしてのみ参照）
- 週次SQ（Weekly オプション）への対応（将来の拡張として検討）
- 15分遅延の補正（将来の拡張として検討）
- データの同梱（キャッシュ機構で対応）

---

## Future Extensibility

本設計により、以下の市場を将来追加可能：

| 市場 | タイムゾーン | 追加時の主な実装内容 |
|------|------------|---------------------|
| 東証株式 | JST | 営業日ルール、立会時間（9:00-15:30）、SQ日なし |
| 米国株式/先物 | EST/EDT | 営業日ルール、立会時間、オプション満期日ルール |
| CME日経225 | CST/CDT | 営業日ルール、立会時間、CME固有のSQ日 |
